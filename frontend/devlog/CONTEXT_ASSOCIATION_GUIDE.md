# 任务关联上下文功能使用指南

## 功能概述

任务关联上下文功能已完成开发，允许用户将工作上下文（活动记录）关联到具体任务。

### 主要功能

1. **任务详情页面** - 查看任务详细信息和关联的上下文
2. **关联上下文区域** - 展示已关联和未关联的上下文列表
3. **上下文卡片** - 以卡片形式展示上下文信息
4. **关联/取消关联** - 一键关联或取消关联操作
5. **任务名称点击跳转** - 从任务列表快速进入详情页

## 页面访问

- 项目详情：`/project-management/{项目ID}`
- 任务详情：`/project-management/{项目ID}/tasks/{任务ID}`

## 使用流程

### 1. 访问任务详情页

#### 方法一：从任务列表点击
1. 访问项目详情页
2. 在任务列表中点击任务名称
3. 悬停时会显示外部链接图标
4. 点击后跳转到任务详情页

#### 方法二：直接访问URL
```
http://localhost:3000/project-management/1/tasks/1
```

### 2. 查看任务信息

在任务详情页有两个标签页：

#### 任务信息标签
- 任务描述
- 任务状态
- 创建时间
- 更新时间
- 关联上下文数量

#### 关联上下文标签
- 已关联的上下文列表
- 可关联的上下文列表（未关联的上下文）

### 3. 关联上下文到任务

1. 点击"关联上下文"标签
2. 在"可关联的上下文"区域查看可用的上下文
3. 每个上下文卡片显示：
   - AI生成的标题
   - 来源应用名称
   - 窗口标题
   - 时间范围
   - AI摘要内容
   - 记录时间戳
4. 点击卡片底部的"关联至此任务"按钮
5. 上下文立即从"可关联"列表移动到"已关联"列表

### 4. 取消关联上下文

1. 在"已关联的上下文"区域找到要取消的上下文
2. 点击卡片底部的"取消关联"按钮
3. 上下文立即移回"可关联的上下文"列表

## 上下文卡片信息

每个上下文卡片显示以下信息：

### 基本信息
- 📝 **AI标题** - AI生成的活动标题
- 💻 **应用名称** - 来源应用（如：Chrome、VSCode）
- 📄 **窗口标题** - 当时的窗口标题
- ⏱️ **时间范围** - 活动的起止时间和持续时长

### 内容摘要
- 📋 **AI摘要** - AI生成的活动内容摘要（3行预览）

### 元数据
- 🕐 **记录时间** - 上下文记录的创建时间

## 技术实现

### 已创建的文件

#### 1. 类型定义 - `frontend/lib/types.ts`
```typescript
export interface Context {
  id: number;
  app_name?: string;
  window_title?: string;
  start_time?: string;
  end_time?: string;
  ai_title?: string;
  ai_summary?: string;
  task_id?: number;
  created_at?: string;
}
```

#### 2. API接口 - `frontend/lib/api.ts`
- `getContexts()` - 获取上下文列表
- `getContext()` - 获取单个上下文
- `updateContext()` - 更新上下文（关联/取消关联）

#### 3. 任务详情页 - `frontend/app/project-management/[id]/tasks/[taskId]/page.tsx`
- 显示任务详细信息
- 标签页切换
- 关联/取消关联功能
- 自动刷新列表

#### 4. 上下文卡片 - `frontend/components/context/ContextCard.tsx`
- 展示上下文详细信息
- 时间格式化
- 关联/取消关联按钮
- 悬停效果

#### 5. 上下文列表 - `frontend/components/context/ContextList.tsx`
- 网格布局（响应式）
- 批量展示上下文卡片

#### 6. 任务组件更新
- `TaskItem.tsx` - 添加点击跳转功能
- `TaskList.tsx` - 传递项目ID

## 界面特点

### 标签页设计
- 清晰的标签页切换
- 徽章显示关联上下文数量
- 激活状态有明显视觉反馈

### 卡片设计
- 网格布局（桌面2列，移动端1列）
- 悬停阴影效果
- 信息层次清晰
- 图标+文字的信息展示

### 操作反馈
- Toast 通知提示操作结果
- 列表实时更新
- 按钮状态清晰

### 响应式设计
- 移动端友好
- 网格自动调整
- 文本截断避免溢出

## API 端点

后端 API 端点：

- `GET /api/contexts` - 获取上下文列表
  - 参数：`associated` (true/false) - 是否已关联
  - 参数：`task_id` - 按任务ID过滤
  - 参数：`limit`, `offset` - 分页

- `GET /api/contexts/{id}` - 获取单个上下文

- `PUT /api/contexts/{id}` - 更新上下文
  - Body: `{ "task_id": 1 }` - 关联到任务
  - Body: `{ "task_id": null }` - 取消关联

## 数据流程

### 关联上下文流程
```
1. 用户点击"关联至此任务"按钮
   ↓
2. 调用 api.updateContext(contextId, { task_id: taskId })
   ↓
3. 后端更新 contexts 表的 task_id 字段
   ↓
4. 前端显示成功提示
   ↓
5. 刷新已关联和未关联列表
   ↓
6. 卡片从"可关联"移动到"已关联"
```

### 取消关联流程
```
1. 用户点击"取消关联"按钮
   ↓
2. 调用 api.updateContext(contextId, { task_id: null })
   ↓
3. 后端将 contexts 表的 task_id 设置为 null
   ↓
4. 前端显示成功提示
   ↓
5. 刷新列表
   ↓
6. 卡片从"已关联"移回"可关联"
```

## 使用示例

### 场景1：开发任务关联代码上下文

1. 创建任务："实现用户登录功能"
2. 访问任务详情页
3. 切换到"关联上下文"标签
4. 查看最近的工作记录
5. 找到编写登录代码时的VSCode记录
6. 点击"关联至此任务"
7. 该上下文现在关联到"用户登录"任务

### 场景2：会议任务关联会议记录

1. 创建任务："产品规划会议"
2. 访问任务详情页
3. 查看可关联的上下文
4. 找到Zoom或Teams的会议窗口记录
5. 关联到任务
6. 后续可快速查看会议内容

### 场景3：整理工作记录

1. 定期查看未关联的上下文
2. 为每个上下文找到对应任务
3. 批量关联
4. 保持工作记录有序

## 启动项目

### 启动后端
```bash
# 激活 conda 环境
conda activate laptop_showcase

# 启动 FastAPI 服务器
cd lifetrace
python server.py
```

### 启动前端
```bash
cd frontend
pnpm dev
```

访问：
- 项目列表：http://localhost:3000/project-management
- 项目详情：http://localhost:3000/project-management/1
- 任务详情：http://localhost:3000/project-management/1/tasks/1

## 注意事项

### 1. 上下文数据来源
- 上下文数据来自系统的活动记录
- 需要后端记录器正常运行
- AI标题和摘要由LLM自动生成

### 2. 关联关系
- 一个上下文只能关联一个任务
- 一个任务可以关联多个上下文
- 关联后可以随时取消

### 3. 性能考虑
- 列表默认加载最多100条
- 使用分页可以处理更多数据
- 卡片使用虚拟滚动（未来优化）

### 4. 数据同步
- 关联/取消关联立即生效
- 列表自动刷新
- 无需手动刷新页面

## 后续可扩展功能

### 功能增强
- 🔍 搜索和筛选上下文
- 📅 按时间范围筛选
- 🏷️ 按应用类型筛选
- 📊 上下文统计图表
- 📎 批量关联/取消关联
- 💬 上下文评论
- ⭐ 上下文重要性标记

### 界面优化
- 虚拟滚动优化大列表
- 拖拽排序
- 快捷键支持
- 预览截图
- 时间线视图

### 智能功能
- AI推荐相关上下文
- 自动关联建议
- 上下文去重
- 智能分组

## 代码质量

- ✅ TypeScript 类型检查通过
- ✅ ESLint 检查无错误
- ✅ 遵循 shadcn/ui 设计规范
- ✅ 响应式设计
- ✅ 代码注释清晰

## 相关文档

- [项目管理功能](./PROJECT_MANAGEMENT_GUIDE.md)
- [任务管理功能](./TASK_MANAGEMENT_GUIDE.md)
- [上下文管理API](../../lifetrace/devlog/CONTEXT_MANAGEMENT_API.md)

## 总结

任务关联上下文功能已完全实现，提供了：
- ✅ 直观的任务详情页面
- ✅ 清晰的上下文展示
- ✅ 便捷的关联操作
- ✅ 实时的列表更新
- ✅ 友好的用户体验

现在您可以轻松地将工作活动记录关联到具体任务，更好地追踪和管理工作进度！🎉

