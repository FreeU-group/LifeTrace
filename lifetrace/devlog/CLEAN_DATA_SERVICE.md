# 数据清理服务开发日志

## 功能概述

实现了一个自动数据清理服务，用于管理截图数量，防止磁盘空间无限增长。

## 主要特性

### 1. 截图数量限制

- 在系统配置中添加了 `jobs.clean_data.max_screenshots` 配置项
- 默认值：10000 张截图
- 可通过配置文件动态调整
- 支持热重载：修改配置后自动更新

### 2. 定时清理任务

- 任务名称：`clean_data`（数据清理）
- 默认启用：`enabled: true`
- 检查间隔：3600 秒（1 小时）
- 支持热重载：可通过修改配置文件动态启用/禁用和调整间隔

### 3. 清理策略

当截图数量超过限制时：
1. 计算需要删除的数量：`当前数量 - 最大限制`
2. 按创建时间排序，删除最老的截图
3. **根据 `delete_file_only` 配置决定清理范围**：
   - **`delete_file_only: true`（默认）**：只删除图片文件
     - 保留截图记录（元数据）
     - 保留 OCR 结果（文本内容可搜索）
     - 保留搜索索引
     - 保留事件关联关系
     - 只删除占用磁盘空间的图片文件
   - **`delete_file_only: false`**：同时删除文件和记录
     - 删除图片文件
     - 删除截图记录
     - 删除 OCR 结果
     - 删除搜索索引
     - 删除处理队列记录

### 4. 孤立文件清理（可选）

提供了清理孤立文件的功能（文件存在但数据库中无记录）：
- 扫描截图目录下的所有图片文件
- 对比数据库记录
- 删除数据库中不存在的文件
- 当前未启用（可按需启用）

## 文件变更

### 1. 配置文件 (`lifetrace/config/default_config.yaml`)

```yaml
# 定时任务
jobs:
  clean_data:
    name: '数据清理'
    enabled: true
    interval: 3600  # 检查间隔（秒），默认每小时检查一次
    max_screenshots: 10000  # 最大截图数量限制
    delete_file_only: true  # 只删除文件（true），还是同时删除记录（false）

# 存储配置
storage:
  max_days: 30  # 数据保留天数
  deduplicate: true  # 启用去重
```

### 2. 新增文件 (`lifetrace/jobs/clean_data.py`)

实现了 `DataCleaner` 类，包含：
- `clean_old_screenshots()`: 清理超出限制的旧截图
- `clean_orphaned_files()`: 清理孤立文件（可选）
- `run()`: 执行完整的清理任务

### 3. 任务管理器更新 (`lifetrace/jobs/job_manager.py`)

添加了以下方法：
- `_start_clean_data_service()`: 启动数据清理服务
- `_handle_clean_data_config_change()`: 处理配置变更

## 使用方式

### 1. 调整最大截图数量

编辑配置文件 `lifetrace/config/config.yaml`：

```yaml
jobs:
  clean_data:
    max_screenshots: 5000  # 修改为 5000 张
```

### 2. 调整检查间隔

```yaml
jobs:
  clean_data:
    interval: 1800  # 修改为 30 分钟检查一次
```

### 3. 禁用自动清理

```yaml
jobs:
  clean_data:
    enabled: false
```

### 4. 手动触发清理（通过 API 或调度器管理界面）

系统启动后，可以通过调度器管理接口手动触发清理任务。

## 日志示例

### 正常运行（未超限）

```
[INFO] 数据清理服务已初始化，最大截图数量: 10000
[INFO] 开始执行数据清理任务
[INFO] 截图数量 (5234) 未超过限制 (10000)，无需清理
[INFO] 数据清理任务完成，耗时: 0.15秒
```

### 清理旧数据

```
[INFO] 数据清理服务已初始化，最大截图数量: 10000
[INFO] 开始执行数据清理任务
[INFO] 截图数量 (12345) 超过限制 (10000)，需要删除 2345 张最老的截图文件（保留数据库记录）
[INFO] 数据清理完成: 删除了 2345 个截图文件（保留了数据库记录）
[INFO] 数据清理任务完成，耗时: 8.45秒
```

## 性能考虑

1. **只删除文件**：不涉及数据库删除操作，速度快
2. **索引优化**：利用 `created_at` 索引快速查询最老的记录
3. **错误处理**：单个文件删除失败不影响整体流程
4. **日志记录**：详细记录清理过程，便于监控和调试
5. **事务安全**：使用数据库事务确保数据一致性

## 注意事项

### ⚠️ 重要提示

1. **图片不可恢复**：删除的图片文件无法恢复，但数据库记录仍然保留
2. **磁盘空间**：只删除图片文件，立即释放磁盘空间
3. **历史记录**：数据库记录、OCR 文本、搜索索引都完整保留
4. **图片显示**：被清理的截图在前端会显示"图片不存在"，但元数据和文本仍可查看
5. **搜索功能**：OCR 文本保留，搜索功能不受影响

### 设计优势

- ✅ 历史时间线完整，可以查看事件发生的时间和顺序
- ✅ OCR 识别的文本内容完整保留，可以搜索历史
- ✅ 事件和上下文关系保留，项目管理功能不受影响
- ✅ 只删除占用空间的图片文件，最大限度节省磁盘
- ✅ 数据库体积很小（相比图片），保留记录几乎不占空间

## 未来优化

1. 支持按事件清理（保持事件完整性）
2. 支持按应用类型设置不同的保留策略
3. 添加清理前的备份功能
4. 支持压缩归档而非直接删除
5. 提供清理预览功能（dry-run 模式）

## 测试建议

1. 设置较小的 `max_screenshots` 值（如 100）进行测试
2. 观察日志输出，确认清理逻辑正确
3. 验证文件系统中的文件确实被删除
4. 验证数据库记录和文件系统保持一致
5. 测试配置热重载功能

## 相关链接

- 配置文件：`lifetrace/config/default_config.yaml`
- 清理服务：`lifetrace/jobs/clean_data.py`
- 任务管理器：`lifetrace/jobs/job_manager.py`
- 数据库管理：`lifetrace/storage/database.py`
