# 自动关联服务文档

## 概述

自动关联服务是一个后台线程服务，能够智能地将未关联的上下文（事件）自动关联到最合适的任务上。该服务使用大语言模型（LLM）进行智能分析，根据上下文内容、项目目标和任务描述来判断最佳的关联关系。

## 功能特性

### 核心功能

1. **自动获取未关联上下文**：定期从数据库中获取一批未关联到任务的上下文记录
2. **智能项目判断**：根据上下文内容（应用名称、窗口标题、OCR文本）判断其归属的项目
3. **任务匹配**：针对归属项目下所有"进行中"的任务，使用LLM判断最匹配的任务
4. **置信度评估**：为每个关联提供置信度评分（0-1之间）
5. **自动关联**：当置信度超过阈值时，自动更新数据库中的关联关系
6. **完善的日志系统**：记录每次关联决策的详细过程，便于调试和优化

### 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                    自动关联服务主循环                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
         ┌──────────────────────────────────────┐
         │ a. 获取一批未关联的上下文（batch_size） │
         └──────────────────────────────────────┘
                              │
                              ▼
         ┌──────────────────────────────────────┐
         │ 确定上下文归属的项目                  │
         │ - 获取上下文关联的截图                │
         │ - 提取OCR文本内容                    │
         │ - 使用LLM判断最相关的项目            │
         └──────────────────────────────────────┘
                              │
                              ▼
         ┌──────────────────────────────────────┐
         │ b. 获取项目下所有"进行中"的任务       │
         └──────────────────────────────────────┘
                              │
                              ▼
         ┌──────────────────────────────────────┐
         │ c. 构建面向 LLM 的 Prompt            │
         │ - 项目信息（名称、目标）              │
         │ - 上下文信息（应用、窗口、OCR文本）   │
         │ - 任务列表（ID、名称、描述）          │
         └──────────────────────────────────────┘
                              │
                              ▼
         ┌──────────────────────────────────────┐
         │ d. 调用 LLM API 并解析 JSON 结果     │
         │ {                                    │
         │   "task_id": <任务ID>,               │
         │   "confidence_score": <置信度>,      │
         │   "reasoning": "<原因说明>"          │
         │ }                                    │
         └──────────────────────────────────────┘
                              │
                              ▼
         ┌──────────────────────────────────────┐
         │ e. 根据置信度阈值决定是否关联         │
         │ - 置信度 >= 阈值：执行关联            │
         │ - 置信度 < 阈值：跳过                │
         └──────────────────────────────────────┘
                              │
                              ▼
         ┌──────────────────────────────────────┐
         │ f. 记录决策过程到日志                 │
         │ - 上下文ID、项目ID、任务ID           │
         │ - 置信度、关联原因                    │
         │ - 是否执行了关联                      │
         └──────────────────────────────────────┘
                              │
                              ▼
              等待 check_interval 秒后继续
```

## 配置说明

### 配置文件路径

`lifetrace/config/config.yaml`

### 配置项

```yaml
auto_association:
  enabled: true                    # 是否启用自动关联服务
  confidence_threshold: 0.7        # 置信度阈值（0-1之间）
  batch_size: 10                   # 每次处理的上下文数量
  check_interval: 60               # 检查间隔（秒）
```

### 配置项说明

- **enabled**：控制服务是否启动
  - `true`：启用服务
  - `false`：禁用服务

- **confidence_threshold**：置信度阈值
  - 范围：0.0 - 1.0
  - 建议值：0.7
  - 只有当LLM判断的置信度 >= 该阈值时，才会执行自动关联
  - 较高的阈值会减少误关联，但可能遗漏一些潜在的正确关联
  - 较低的阈值会增加关联数量，但可能产生一些不准确的关联

- **batch_size**：批处理大小
  - 每次从数据库获取的未关联上下文数量
  - 建议值：10-50
  - 较大的值可以加快处理速度，但可能增加单次处理时间

- **check_interval**：检查间隔
  - 单位：秒
  - 建议值：60（1分钟）
  - 服务会每隔这个时间检查一次是否有新的未关联上下文需要处理

## 代码结构

### 主要文件

1. **服务模块**：`lifetrace/jobs/associate.py`
   - `AutoAssociationService` 类：核心服务类

2. **配置管理**：`lifetrace/util/config.py`
   - 添加了自动关联服务的配置属性

3. **服务器集成**：`lifetrace/server.py`
   - 在应用启动时初始化并启动服务
   - 在应用关闭时停止服务

### 核心方法

#### AutoAssociationService 类

```python
class AutoAssociationService:
    def __init__(self, db_manager, llm_client, confidence_threshold,
                 batch_size, check_interval, enabled):
        """初始化服务"""

    def start(self):
        """启动后台服务线程"""

    def stop(self):
        """停止后台服务线程"""

    def is_running(self) -> bool:
        """检查服务是否在运行"""

    def get_stats(self) -> Dict[str, Any]:
        """获取服务统计信息"""

    def _process_batch(self):
        """处理一批未关联的上下文"""

    def _process_single_context(self, context):
        """处理单个上下文"""

    def _determine_project_for_context(self, context) -> Optional[int]:
        """确定上下文归属的项目"""

    def _get_in_progress_tasks(self, project_id) -> List[Dict]:
        """获取项目下所有进行中的任务"""

    def _build_association_prompt(self, context, project_id, tasks) -> Dict:
        """构建用于LLM判断的提示"""

    def _call_llm_for_association(self, prompt) -> Optional[Dict]:
        """调用LLM进行关联判断"""

    def _associate_context_to_task(self, context_id, task_id,
                                   confidence_score, reasoning) -> bool:
        """将上下文关联到任务"""

    def _log_decision(self, context_id, project_id, task_id,
                     confidence_score, reasoning, associated):
        """记录自动关联的决策过程"""
```

## 使用示例

### 启动服务

服务会在应用启动时自动启动（如果配置中启用）：

```bash
cd lifetrace
python server.py
```

### 查看日志

服务的所有决策过程都会记录到日志文件中：

```bash
# 查看日志文件
tail -f lifetrace/data/logs/$(date +%Y-%m-%d).log | grep "自动关联"
```

### 查看服务统计

服务维护了运行统计信息，可以通过 `get_stats()` 方法获取：

```python
{
    "total_processed": 100,      # 总共处理的上下文数量
    "total_associated": 75,      # 成功关联的数量
    "total_skipped": 25,         # 跳过的数量（置信度不足或其他原因）
    "last_run_time": "2025-11-09T12:34:56",  # 最后运行时间
    "last_error": None           # 最后的错误信息（如果有）
}
```

## 置信度评分标准

LLM 在进行关联判断时，会根据以下标准给出置信度评分：

- **0.9-1.0**：非常确定，上下文内容与任务高度相关
  - 示例：VS Code 编辑某个具体项目的代码文件，任务为"开发该项目的某功能"

- **0.7-0.9**：比较确定，有明显的关联性
  - 示例：浏览器查看该项目的技术文档，任务为"学习相关技术栈"

- **0.5-0.7**：可能相关，但不太确定
  - 示例：聊天工具讨论工作相关内容，但无法确定具体任务

- **0.0-0.5**：不太相关或无法判断
  - 示例：浏览无关网页、玩游戏等与项目任务无关的活动

## 最佳实践

### 1. 置信度阈值设置

- **保守策略**（阈值 0.8-0.9）：
  - 优点：关联准确率高，误关联少
  - 缺点：可能遗漏一些有效关联
  - 适用场景：对准确性要求高的场景

- **平衡策略**（阈值 0.6-0.8）：
  - 优点：在准确性和覆盖率之间取得平衡
  - 缺点：可能产生少量误关联
  - 适用场景：大多数场景的推荐设置

- **激进策略**（阈值 0.4-0.6）：
  - 优点：关联覆盖率高
  - 缺点：误关联率相对较高，需要人工审核
  - 适用场景：希望最大化自动化，愿意后期人工审核

### 2. 批处理大小设置

- **小批量**（5-10）：
  - 响应快，适合实时性要求高的场景
  - 单次处理时间短

- **中批量**（10-30）：
  - 推荐设置，平衡效率和响应时间

- **大批量**（30-50）：
  - 处理效率高，适合大量积压的未关联上下文
  - 单次处理时间较长

### 3. 检查间隔设置

- **高频检查**（30-60秒）：
  - 适合活跃使用场景
  - 能够及时处理新产生的上下文

- **标准检查**（60-120秒）：
  - 推荐设置
  - 平衡了及时性和系统负载

- **低频检查**（120-300秒）：
  - 适合低频使用场景
  - 减少系统负载

### 4. 监控和调优

建议定期检查以下指标：

1. **关联成功率**：`total_associated / total_processed`
   - 目标：60-80%
   - 如果过低（<40%），考虑降低置信度阈值
   - 如果过高（>90%），可能遗漏了一些关联，考虑提高阈值

2. **日志分析**：
   - 定期查看日志中的关联决策
   - 识别误关联的模式
   - 根据实际情况调整阈值

3. **人工审核**：
   - 定期抽查自动关联的结果
   - 对于误关联及时手动修正
   - 根据反馈持续优化配置

## 故障排查

### 服务未启动

检查项：
1. 配置文件中 `auto_association.enabled` 是否为 `true`
2. 查看日志文件是否有错误信息
3. 确认 LLM 配置是否正确

### 没有进行关联

可能原因：
1. 没有未关联的上下文记录
2. 上下文无法确定归属项目
3. 项目没有"进行中"的任务
4. 所有判断的置信度都低于阈值

解决方法：
- 查看日志文件了解具体跳过原因
- 适当降低置信度阈值
- 确保项目中有"进行中"状态的任务

### 关联不准确

解决方法：
1. 提高置信度阈值
2. 检查项目目标和任务描述是否清晰
3. 改进任务的描述信息，使其更具体
4. 查看日志中的 reasoning 字段了解 LLM 的判断依据

### 性能问题

如果服务导致系统负载过高：
1. 增加 `check_interval`（降低检查频率）
2. 减小 `batch_size`（减少单次处理量）
3. 考虑在系统空闲时段运行

## 未来优化方向

1. **增加用户反馈机制**：
   - 允许用户对自动关联结果进行评分
   - 根据反馈动态调整阈值

2. **学习历史关联模式**：
   - 记录成功的关联案例
   - 使用机器学习方法优化匹配算法

3. **支持自定义规则**：
   - 允许用户定义关联规则
   - 与 LLM 判断相结合

4. **批量关联预览**：
   - 在实际执行前展示关联建议
   - 允许用户批量确认或拒绝

5. **关联质量评估**：
   - 自动评估关联质量
   - 对低质量关联进行标记

## 技术依赖

- **LLM API**：需要配置可用的大语言模型 API
- **数据库**：SQLite（通过 SQLAlchemy）
- **Python 版本**：3.8+
- **主要依赖库**：
  - `openai`：用于调用 LLM API
  - `sqlalchemy`：数据库 ORM
  - `pydantic`：数据验证

## 许可证

本功能遵循项目的整体许可证。
